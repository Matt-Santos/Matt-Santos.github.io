name: Build Website

on: [push, workflow_dispatch]

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    build-site:
        name: Build Jekyll Website
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v4
          - name: Get Project List
            run: |
                mkdir -p _data
                gh repo list -L 200 --json \
                name,description,createdAt,updatedAt,\
                forkCount,stargazerCount,watchers,languages,\
                primaryLanguage,repositoryTopics,isArchived,\
                isFork,isPrivate,isTemplate \
                $OWNER > _data/repoData.json
            env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                OWNER: ${{ github.repository_owner }}
          - name: Get Project Files
            run: |
                gh repo list -L 200 $OWNER > repos
                mkdir _includes/$OWNER
                awk '{print $1}' repos | while read line ; do \
                mkdir _includes/$line ; \
                curl -o _includes/$line/README.md https://raw.githubusercontent.com/$line/refs/heads/main/documents/README.md ; \
                done
            env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                OWNER: ${{ github.repository_owner }}
          - name: Create Project Names
            uses: mikefarah/yq@v4.44.3
            with:
                cmd: yq e -r '.[].name' _data/repoData.json > _data/repoList
          - name: Create Individual Project Pages
            run: |
                mkdir -p projects
                cat _data/repoList | while read line; do \
                    echo "---" > projects/${line}.html; \
                    echo "layout: project" >> projects/${line}.html; \
                    echo "title: ${line}" >> projects/${line}.html; \
                    echo "bg: https://raw.githubusercontent.com/Matt-Santos/${line}/refs/heads/main/documents/images/banner.png" >> projects/${line}.html; \
                    echo "---" >> projects/${line}.html; \
                    cat projects/${line}.html; \
                done
                ls projects
          - name: Setup Ruby
            uses: ruby/setup-ruby@v1
            with:
              ruby-version: '3.3'
              bundler-cache: true
              cache-version: 0
          - name: Setup Pages
            id: pages
            uses: actions/configure-pages@v5
          - name: Build with Jekyll
            run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
            env:
              JEKYLL_ENV: production
          - name: Upload artifact
            uses: actions/upload-pages-artifact@v3
    deploy:
        name: Deploy Site
        needs: build-site
        environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
          - name: Deploy to GitHub Pages
            id: deployment
            uses: actions/deploy-pages@v4