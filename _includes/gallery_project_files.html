<div class="w3-center w3-row">
<!-- File Filter List (in Priority Order) -->
{% assign file_targets = ".stl,.kicad_sch,.kicad_pcb,.html,.png,.pdf" | split: "," -%}

<!-- Primary Search Loop -->
{% for target in file_targets -%}
	{% for file in site.data.repoFiles[i].files -%}
		{% assign filenameparts = file.path | split: "/" -%}
		{% assign extname = filenameparts | last | split: "." | last | prepend: "." -%}
		{% assign filename = filenameparts | last | replace: extname,"" -%}
		{% if extname == target and file.path contains "hardware/" -%}
		{% capture fileurl %}https://raw.githubusercontent.com/Matt-Santos/{{ site.data.repoData[i].name }}/refs/heads/main/{{ file.path }}{% endcapture -%}
			<!-- Select Targets -->
			{% capture href_target %}<a href="{{ fileurl }}" alt="{{ filename }}" class="glightbox w3-col m6 w3-padding">{% endcapture -%}
			{% case target -%}
				{% when ".stl" -%}
					{% capture href_target %}<a href="#stl_{{ forloop.index }}" class="glightbox w3-col m6 w3-padding" data-width="200vh" data-height="auto" data-draggable="false" data-touchFollowAxis="false">{% endcapture -%}
					{% capture image_target %}<img src="/assets/images/Misc/file_type_step.jpg" alt="{{ filename }}" class="w3-image w3-round-xlarge"/>{% endcapture -%}
					<div id="stl_{{ forloop.index }}" class="w3-center" style="display: none"><script src="https://embed.github.com/view/3d/Matt-Santos/{{ site.data.repoData[i].name }}/main/{{ file.path }}"></script></div>
				{% when ".kicad_sch" -%}
					{% capture href_target %}<a href="#kicanvas_sch{{ forloop.index }}" class="glightbox w3-col m6 w3-padding" data-width="200vh" data-height="auto" data-draggable="false" data-touchFollowAxis="false">{% endcapture -%}
					{% capture image_target %}<img src="/assets/images/Misc/file_type_kicad_sch.jpg" alt="{{ filename }}" class="w3-image w3-round-xlarge"/>{% endcapture -%}
					<kicanvas-embed id="kicanvas_sch{{ forloop.index }}" src="{{ fileurl }}" controls="basic" style="display: none"></kicanvas-embed>
				{% when ".kicad_pcb" -%}
					{% capture href_target %}<a href="#kicanvas_pcb{{ forloop.index }}" class="glightbox w3-col m6 w3-padding" data-width="200vh" data-height="auto" data-draggable="false" data-touchFollowAxis="false">{% endcapture -%}
					{% capture image_target %}<img src="/assets/images/Misc/file_type_kicad_pcb.jpg" alt="{{ filename }}" class="w3-image w3-round-xlarge"/>{% endcapture -%}
					<kicanvas-embed id="kicanvas_pcb{{ forloop.index }}" src="{{ fileurl }}" controls="basic" style="display: none"></kicanvas-embed>
				{% when ".html" -%}
					{% capture href_target %}<a href="#" onclick="replacePageContent('{{ fileurl }}'); return false;" alt="{{ filename }}" class="w3-col m6 w3-padding">{% endcapture -%}
					{% capture image_target %}<img src="/assets/images/Misc/file_type_html.jpg" alt="{{ filename }}" class="w3-image w3-round-xlarge"/>{% endcapture -%}
				
				{% when ".pdf" -%}
					{% capture href_target %}<a href="https://docs.google.com/viewer?url={{ fileurl }}" alt="{{ filename }}" class="w3-col m6 w3-padding">{% endcapture -%}
					{% capture image_target %}<img src="/assets/images/Misc/file_type_pdf.jpg" alt="{{ filename }}" class="w3-image w3-round-xlarge"/>{% endcapture -%}
			{% endcase -%}
			<!-- Fallback image Target -->
			{% assign img_ref = file.path | replace: extname,".png" -%}
			{% for file2 in site.data.repoFiles[i].files -%}
				{% if file2.path contains img_ref -%}
					{% capture image_target %}<img src="//images.weserv.nl/?url={{ fileurl }}&w=400&h=400&output=jpg&q=50&fit=cover" alt="{{ filename }}" class="w3-image w3-round-xlarge"/>{% endcapture -%}
					{% break -%}
				{% endif -%}
			{% endfor -%}
			{% if image_target == nil -%}
				{% capture image_target %}<img src="/assets/images/Misc/file_type_pdf.jpg" alt="{{ filename }}" class="w3-image w3-round-xlarge"/>{% endcapture -%}
			{% endif -%}
			
			<!-- Create Reference Entry -->
			{{ href_target }}
				{{ image_target }}
				<span>{{ filename }}{{ extname }}</span>
			</a>
			{% assign image_target = nil -%}
		{% endif -%}
	{% endfor -%}
{% endfor -%}
</div>
<script type="module" src="/assets/js/kicanvas.js"></script>

<script>
async function replacePageContent(url) {
	try {
		const response = await fetch(url);
		if (!response.ok) throw new Error(`Failed to fetch: ${response.statusText}`);
		const newContent = await response.text();
		const tempDiv = document.createElement("div");
		tempDiv.innerHTML = newContent;
		const originalOnload = window.onload;
		let newOnload = null;
		const scripts = tempDiv.querySelectorAll("script");
		for (const script of scripts) {
			const newScript = document.createElement("script");
			if (script.src) {
				newScript.src = script.src;
				newScript.async = false;
			} 
			else {
				newScript.textContent = script.textContent;
				const onloadMatch = script.textContent.match(/window\.onload\s*=\s*function\s*\(\)\s*{([\s\S]*?)}/);
				if (onloadMatch && onloadMatch[1]) {
					newOnload = new Function(onloadMatch[1].trim());
				}
			}
			document.body.appendChild(newScript);
		}
		document.documentElement.innerHTML = tempDiv.innerHTML;
		if (newOnload) {
			window.onload = newOnload;
		} 
		else if (originalOnload) {
			window.onload = originalOnload;
		}
		if (typeof window.onload === "function") {
			window.onload();
		}
	}
	catch (error) {
		console.error("Error replacing page content:", error);
	}
}
</script>